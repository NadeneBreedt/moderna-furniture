<link rel="stylesheet" href="styles/modal.css">

<!-- Floating Quote Button -->
<button id="quote-floating-btn" class="quote-floating-btn">
  Get My Quote
  
  
</button>

<!-- Quote Modal (initially hidden) -->
<div id="quote-modal-overlay" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
">
  <div id="quote-modal" style="
    background-color: white;
    border-radius: 8px;
    padding: 2rem;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
  ">
    <button id="quote-modal-close" style="
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #78716c;
    ">
      &times;
    </button>
    
    <h2 style="
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: #292524;
    ">
      Get Your Custom Quote
    </h2>
    
    <div id="quote-items" style="margin-bottom: 1.5rem;">
      <h3 style="
        font-size: 1.2rem;
        margin-bottom: 1rem;
        color: #44403c;
      ">
        Selected Items
      </h3>
      
      <table id="quote-items-table" style="
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
      ">
        <thead>
          <tr>
            <th style="text-align: left; padding: 0.5rem; border-bottom: 1px solid #e7e5e4;">Product</th>
            <th style="text-align: left; padding: 0.5rem; border-bottom: 1px solid #e7e5e4;">Variant</th>
            <th style="text-align: center; padding: 0.5rem; border-bottom: 1px solid #e7e5e4;">Qty</th>
            <th style="text-align: right; padding: 0.5rem; border-bottom: 1px solid #e7e5e4;"></th>
          </tr>
        </thead>
        <tbody>
          <!-- Items will be dynamically inserted here -->
        </tbody>
      </table>
    </div>
    
    <form id="quote-form" style="
      display: flex;
      flex-direction: column;
      gap: 1rem;
    ">
      <div style="
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      ">
        <div style="flex: 1; min-width: 200px;">
          <label for="quote-name" style="
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #44403c;
          ">
            Your Name
          </label>
          <input 
            type="text" 
            id="quote-name" 
            name="name" 
            required
            style="
              width: 100%;
              padding: 0.75rem;
              border: 1px solid #e7e5e4;
              border-radius: 4px;
              font-size: 1rem;
            "
          >
        </div>
        
        <div style="flex: 1; min-width: 200px;">
          <label for="quote-email" style="
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #44403c;
          ">
            Email Address
          </label>
          <input 
            type="email" 
            id="quote-email" 
            name="email" 
            required
            style="
              width: 100%;
              padding: 0.75rem;
              border: 1px solid #e7e5e4;
              border-radius: 4px;
              font-size: 1rem;
            "
          >
        </div>
      </div>
      
      <div>
        <label for="quote-phone" style="
          display: block;
          margin-bottom: 0.5rem;
          font-size: 0.9rem;
          color: #44403c;
        ">
          Phone Number (optional)
        </label>
        <input 
          type="tel" 
          id="quote-phone" 
          name="phone"
          style="
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e7e5e4;
            border-radius: 4px;
            font-size: 1rem;
          "
        >
      </div>
      
      <div>
        <label for="quote-attachment" style="
          display: block;
          margin-bottom: 0.5rem;
          font-size: 0.9rem;
          color: #44403c;
        ">
          Attachment (optional)
        </label>
        <input 
          type="file" 
          id="quote-attachment" 
          name="attachment"
          style="
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e7e5e4;
            border-radius: 4px;
            font-size: 1rem;
            background-color: #f5f5f4;
          "
        >
      </div>
      
      <!-- Added comment box -->
      <div>
        <label for="quote-comments" style="
          display: block;
          margin-bottom: 0.5rem;
          font-size: 0.9rem;
          color: #44403c;
        ">
          Comments (optional)
        </label>
        <textarea 
          id="quote-comments" 
          name="comments"
          placeholder="Any specific requirements or questions?"
          style="
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e7e5e4;
            border-radius: 4px;
            font-size: 1rem;
            min-height: 100px;
            resize: vertical;
          "
        ></textarea>
      </div>
      
      <!-- Privacy note -->
      <div style="font-size: 0.85rem; color: #78716c; margin-top: 0.5rem;">
        We'll only use your information to respond to your quote request. Your privacy is important to us.
      </div>
      
      <button type="submit" style="
        width: 100%;
        background-color: #292524;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.30rem;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
        margin-top: 1rem;
      ">
        Get My Quote
      </button>
    </form>
  </div>
</div>

<!-- Add a visual notification when items are added to quote -->
<div id="quote-notification" style="
  position: fixed;
  bottom: 80px;
  right: 24px;
  background-color: #292524;
  color: white;
  padding: 1rem;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  z-index: 999;
  display: none;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.3s ease;
">
  <span>Item added to your quote!</span>
  <button id="view-quote-btn" style="
    background: white;
    color: #292524;
    border: none;
    border-radius: 4px;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
  ">
    View Quote
  </button>
</div>

<style>
  .quantity-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  
  .quantity-controls button {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f5f5f4;
    border: 1px solid #e7e5e4;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
  }
  
  .remove-btn {
    background: none;
    border: none;
    color: #ef4444;
    font-size: 0.875rem;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
  }
  
  /* For product pages - single click quote button */
  .enquire-single-btn {
    display: inline-block;
    background: white;
    color: #292524;
    border: 2px solid #292524;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .enquire-single-btn:hover {
    background: #f5f5f4;
  }
  
  /* Hide the validation popup */
  .validation-popup {
    display: none !important;
  }
  
  /* Simplified blur effect */
  .blur {
    opacity: 0.8;
  }
  
  /* Make sure the modal stays visible */
  #quote-modal {
    opacity: 1 !important;
    background-color: white !important;
  }
  
  /* Make sure the overlay is on top */
  #quote-modal-overlay {
    z-index: 9999 !important;
  }
</style>

<script>
  // Quick quote notification
  function showQuoteNotification() {
    const notification = document.getElementById('quote-notification');
    notification.style.display = 'flex';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      notification.style.display = 'none';
    }, 5000);
  }
  
  // Add click handler for view quote button
  document.getElementById('view-quote-btn').addEventListener('click', function() {
    document.getElementById('quote-notification').style.display = 'none';
    document.getElementById('quote-modal-overlay').style.display = 'flex';
    refreshQuoteTable();
  });
  
  // Update addToQuote function to show notification
  const originalAddToQuote = window.addToQuote;
  window.addToQuote = function(productId, productName, variantName, variantId) {
    // Call the original function
    if (typeof originalAddToQuote === 'function') {
      originalAddToQuote(productId, productName, variantName, variantId);
    } else {
      // Fallback implementation if the original function isn't available
      const items = JSON.parse(localStorage.getItem('quoteItems') || '[]');
      
      // Check if this product is already in the cart with this variant
      const existingItemIndex = items.findIndex(item => 
        item.id === productId && 
        (item.variant_id === variantId || (!item.variant_id && !variantId))
      );
      
      if (existingItemIndex >= 0) {
        // If already in cart, increase quantity
        items[existingItemIndex].quantity = (items[existingItemIndex].quantity || 1) + 1;
      } else {
        // Add new item to cart
        const newItem = {
          id: productId,
          name: productName,
          quantity: 1,
          variant: variantName,
          variant_id: variantId
        };
        
        items.push(newItem);
      }
      
      // Save updated cart to localStorage
      localStorage.setItem('quoteItems', JSON.stringify(items));
    }
    
    // Show the notification
    showQuoteNotification();
    
    // When viewing the quote, apply blur
    document.getElementById('view-quote-btn').addEventListener('click', function() {
      applyBlurToBackground();
    });
  };
  
  // Add event listener to the floating quote button
  document.getElementById('quote-floating-btn').addEventListener('click', function() {
    document.getElementById('quote-modal-overlay').style.display = 'flex';
    if (typeof refreshQuoteTable === 'function') {
      refreshQuoteTable();
    }
  });

  // Override any existing form submission to ensure it doesn't check for items
  const quoteForm = document.getElementById('quote-form');
  if (quoteForm) {
    quoteForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        // Get form values
        const name = document.getElementById('quote-name').value;
        const email = document.getElementById('quote-email').value;
        const phone = document.getElementById('quote-phone').value;
        const comments = document.getElementById('quote-comments').value;
        
        // Get quote items (now optional)
        const items = JSON.parse(localStorage.getItem('quoteItems') || '[]');
        
        // Create data object to send - no validation on items.length
        const quoteData = {
          name: name,
          email: email,
          phone: phone,
          comments: comments,
          items: items
        };
        
        console.log('Submitting quote request:', quoteData);
        
        // Send the data to your server using the existing function
        if (typeof window.submitQuoteToServer === 'function') {
          await window.submitQuoteToServer(quoteData);
        } else {
          // Fallback - simplified version
          alert('Thank you for your quote request. We will be in touch soon!');
        }
        
        // Clear quote items
        localStorage.removeItem('quoteItems');
        
        // Reset form
        this.reset();
        
        // Close modal
        document.getElementById('quote-modal-overlay').style.display = 'none';
        
      } catch (error) {
        console.error('Error submitting quote:', error);
        alert('There was an error submitting your quote. Please try again.');
      }
    }, true); // true for useCapture to override any other handlers
  }

  // Remove the validation dialog that might be showing
  document.addEventListener('DOMContentLoaded', function() {
    // Find and close any validation dialogs
    const closeButtons = document.querySelectorAll('.close-validation-message');
    closeButtons.forEach(btn => btn.click());
  });

  // Specific fix for the "Please add items to your quote first" dialog
  document.addEventListener('DOMContentLoaded', function() {
    // Override the form submission
    const quoteForm = document.getElementById('quote-form');
    if (quoteForm) {
      quoteForm.addEventListener('submit', function(e) {
        // Get all dialogs/popups that might be validation messages
        const validationPopups = document.querySelectorAll('div[role="dialog"], .validation-message, .error-popup');
        validationPopups.forEach(popup => {
          if (popup.textContent.includes('add items') || 
              popup.textContent.includes('Please add items to your quote first')) {
            popup.style.display = 'none';
            // Find and click any close buttons
            const closeButtons = popup.querySelectorAll('button');
            closeButtons.forEach(btn => btn.click());
          }
        });
        
        // Continue with form submission regardless of items
        return true;
      });
    }
    
    // Add a global click handler for the submit button
    document.addEventListener('click', function(e) {
      if (e.target && (e.target.type === 'submit' || 
                       (e.target.tagName === 'BUTTON' && 
                        e.target.closest('#quote-form')))) {
        // Check if there's a validation popup showing
        const popup = document.querySelector('.validation-popup, div[role="dialog"]');
        if (popup && (popup.textContent.includes('add items') || 
                     popup.textContent.includes('Please add items to your quote first'))) {
          // Close it and allow form submission
          popup.style.display = 'none';
          // Find and click any close buttons
          const closeButtons = popup.querySelectorAll('button');
          closeButtons.forEach(btn => {
            if (btn.textContent.includes('Close')) {
              btn.click();
            }
          });
        }
      }
    }, true);
  });
  
  // Close the validation popup if it exists
  function closeValidationPopup() {
    const popup = document.querySelector('div[role="dialog"]');
    if (popup && popup.textContent.includes('Please add items to your quote first')) {
      // Find the close button and click it
      const closeBtn = popup.querySelector('button');
      if (closeBtn) {
        closeBtn.click();
      }
      return true;
    }
    return false;
  }
  
  // Additional function to ensure blur is maintained with simpler approach
  function applyBlurToBackground() {
    const mainContent = document.getElementById('main-content');
    const header = document.getElementById('my-header');
    
    if (mainContent) {
      mainContent.classList.add('blur');
      mainContent.style.opacity = '0.8';
    }
    
    if (header) {
      header.classList.add('blur');
      header.style.opacity = '0.8';
    }
  }

  // Function to remove blur
  function removeBlurFromBackground() {
    const mainContent = document.getElementById('main-content');
    const header = document.getElementById('my-header');
    
    if (mainContent) {
      mainContent.classList.remove('blur');
      mainContent.style.opacity = '1';
    }
    
    if (header) {
      header.classList.remove('blur');
      header.style.opacity = '1';
    }
  }

  // Add direct event handlers to the buttons that open/close the modal
  document.getElementById('quote-floating-btn').addEventListener('click', function() {
    applyBlurToBackground();
  });

  document.getElementById('quote-modal-close').addEventListener('click', function() {
    removeBlurFromBackground();
  });

  // Also add event handlers to the view quote button
  document.getElementById('view-quote-btn').addEventListener('click', function() {
    applyBlurToBackground();
  });

  // Call this periodically to close any validation popups, but not too frequently
  setInterval(closeValidationPopup, 1000);
</script>